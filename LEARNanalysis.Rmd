---
title: "LEARN"
author: "Maria Eckstein"
date: "September 23, 2017"
output: pdf_document
---

```{r Set parameters, load packages, etc.}
# Load packages
library("ggplot2"); library("plyr"); library("reshape"); library("gridExtra")
theme_set(theme_bw())

# What's the base directory of that data?
base_dir = "C:/Users/maria/MEGAsync/Berkeley/LEARN/data"

# Which plots should be saved?
plot_all_trials = T
gg_save  = T

# Which data should be plotted?
n_options_per_level = "[4, 2]"  # 4, 16, 27
# nlightstuple = "3"  # 2 or 3
hier = "hierarchical"  # hierarchical or flat
learning_signal = "novelty"  # novelty or reward
alpha = "0.2"
lambda = "0.5"
```
```{r Read in data}
# Get data directory, create "plots" subfolder
data_dir = paste(base_dir, "/n_options_per_level_", n_options_per_level, "/", hier, "/", learning_signal, "/alpha_", alpha, "/lambda_", lambda, sep = "")
plot_dir = file.path(data_dir, "plots")
if (!dir.exists(plot_dir)) {
  dir.create(plot_dir)
}

# Event history
event_hist = read.csv(file = file.path(data_dir, "event_history_long.csv"), header = T)
event_hist$X = NULL
head(event_hist)
summary(event_hist)

# Value history
v_history = read.csv(file = file.path(data_dir, "v_history_long.csv"), header = T)
v_history$X = NULL
if (hier == "flat") {
  v_history$value[v_history$level > 0] = NA
}
head(v_history)
summary(v_history)

# State history
state_history = read.csv(file = file.path(data_dir, "state_history_long.csv"), header = T)
state_history$X = NULL
head(state_history)
summary(state_history)

# Option history
option_history = read.csv(file = file.path(data_dir, "option_history_long.csv"), header = T)
option_history$X = NULL
head(option_history)
summary(option_history)

# Theta history
theta_history = read.csv(file = file.path(data_dir, "theta_history_long.csv"), header = T)
theta_history$X = NULL
theta_history = subset(theta_history, value != 0)
head(theta_history)
summary(theta_history)

# Elig. trace history
e_history = read.csv(file = file.path(data_dir, "e_history_long.csv"), header = T)
e_history$X = NULL
# e_history = subset(e_history, value != 0)
head(e_history)
summary(e_history)
```
```{r Plot actions options events and values over time}
if (plot_all_trials) {
  for (tr in 0:max(event_hist$trial)) {
    
    # Events/actions in each trial
    gg_event = ggplot(subset(event_hist, trial == tr), aes(action, factor(level))) +
      geom_tile(aes(fill = value), color = "white") +
      labs(x = "Action ID", y = "Level") +
      scale_fill_gradient(low = "black", high = "yellow") +
      theme(legend.position = "none") +
      facet_grid(~ factor(trial, levels = unique(v_history$trial), labels = paste("Trial", unique(v_history$trial))))
    file_path = file.path(plot_dir, "events")
    if (!dir.exists(file_path)) {
      dir.create(file_path)
    }
    if (gg_save) {
      ggsave(file.path(file_path, paste(tr, "event.png", sep = "")), gg_event, width=max(event_hist$action)/2, height=max(event_hist$level))
    }
    
    # State in each trial
    gg_state = gg_event
    gg_state$data = subset(state_history, trial == tr)
    gg_state = gg_state +
      scale_fill_gradient(low = "black", high = "yellow")
    file_path = file.path(plot_dir, "states")
    if (!dir.exists(file_path)) {
      dir.create(file_path)
    }
    if (gg_save) {
      ggsave(file.path(file_path, paste(tr, "state.png", sep = "")), gg_state, width=max(state_history$action)/2, height=max(state_history$level))
    }
    
    # Options in each trial
    gg_option = gg_event
    gg_option$data = subset(option_history, trial == tr)
    gg_option = gg_option +
      scale_fill_gradient(low = "white", high = "steelblue") +
      facet_wrap(~ step)
    
    # Values in each trial
    upper_limit = ifelse(hier == "hierarchical", 1, 2) 
    gg_value = gg_event
    gg_value$data = subset(v_history, trial == tr)
    gg_value = gg_value +
      scale_fill_gradient(low = "white", high = "red", limits = c(0, upper_limit))  # necessary to make each plot based on the same color
    
    # Eligibility traces
    gg_e = gg_value
    gg_e$data = subset(e_history, trial == tr)
    gg_e = gg_e +
      aes(action, feature) +
      scale_fill_gradient(low = "white", high = "purple", limits = c(min(e_history$value), max(e_history$value))) +
      facet_grid(~ factor(option, levels = unique(e_history$option), labels = paste("Option", unique(e_history$option))))
    grob_e_option = grid.arrange(gg_event, gg_option, gg_e)
    
    file_path = file.path(plot_dir, "event_e")
    if (!dir.exists(file_path)) {
      dir.create(file_path)
    }
    if (gg_save) {
      ggsave(file.path(file_path, paste("trial", tr, ".png", sep = "")), grob_e_option, width=length(unique(e_history$option)), height=3*length(unique(event_hist$level)))
    }
    
    # Thetas in each trial
    for (op in unique(theta_history$option)) {
      gg_e$data = subset(e_history, option == op & trial == tr)
      
      theta_dat = subset(theta_history, option == op & updated_option == op & trial == tr)
      if (nrow(theta_dat) > 0) {
        gg_theta = gg_value
        gg_theta$data = theta_dat
        gg_theta = gg_theta +
          aes(action, feature) +
          scale_fill_gradient(low = "white", high = "red", limits = c(min(theta_history$value), max(theta_history$value)))  # necessary to make colors consistent across plots
        
        # Put theta-option graphs together
        if (hier == "hierarchical") {
          grob_theta_option = grid.arrange(gg_theta, gg_e, gg_option, gg_event, ncol = 1)
        } else {  # flat agents don't have options
          grob_theta_option = grid.arrange(gg_theta, gg_state, ncol = 1)
        }
        
        file_path = file.path(plot_dir, paste("grob_theta_option", op))
        if (!dir.exists(file_path)) {
          dir.create(file_path)
        }
        if (gg_save) {
          ggsave(file.path(file_path, paste("trial", tr, ".png", sep = "")), grob_theta_option, width=max(event_hist$action)/2, height=4*max(event_hist$level))
        }
      }
    }
    
    # Put value-option-event graphs together
    if (hier == "hierarchical") {
      grob_event_value = grid.arrange(gg_value, gg_option, gg_event, ncol = 1)
    } else {
      grob_event_value = grid.arrange(gg_value, gg_event, ncol = 1)
    }
    
    file_path = file.path(plot_dir, paste("grob_event_value"))
    if (!dir.exists(file_path)) {
      dir.create(file_path)
    }
    if (gg_save) {
      ggsave(file.path(file_path, paste("trial", tr, ".png", sep = "")), grob_event_value, width=max(event_hist$action)/2, height=3*max(event_hist$level))
    }
  }
}
# Events, selected trials
gg_event_multi = gg_event
gg_event_multi$data = subset(event_hist, trial < 10 | trial > (max(trial) - 10))
gg_event_multi = gg_event_multi + facet_wrap(~ trial)

# Options, selected trials
gg_option_multi = gg_option
gg_option_multi$data = subset(option_history, trial < 10 | trial > (max(trial) - 10))
gg_option_multi = gg_option_multi + facet_wrap(~ trial)

# Values, selected trials
gg_value_multi = gg_value
gg_value_multi$data = subset(v_history, trial < 10 | trial > (max(trial) - 10))
gg_value_multi = gg_value_multi + facet_wrap(~ trial)

if (gg_save) {
  ggsave(file.path(plot_dir, "gg_event_multi.png"), gg_event_multi, width=6, height=4)
  ggsave(file.path(plot_dir, "gg_option_multi.png"), gg_option_multi, width=6, height=4)
  ggsave(file.path(plot_dir, "gg_value_multi.png"), gg_value_multi, width=6, height=4)
}
```

```{r Plot novelty values over time}
gg_summary_novelty = ggplot(v_history, aes(trial, value, color = factor(action), group = level)) +
  stat_summary(fun.data = "mean_se", geom = "pointrange") +
  stat_summary(fun.y = "mean", geom = "line", color = "black") +
  geom_line(aes(group = action)) +
  coord_cartesian(y=c(0, upper_limit), x=c(0, 350)) +
  theme(legend.position = "none") +
  facet_grid(~ factor(level, levels = unique(v_history$level), labels = paste("Level", unique(v_history$level))))
if (gg_save) {
  ggsave(file.path(plot_dir, "gg_summary_novelty.png"), gg_summary_novelty, width = 6, height = 3)
}
```
```{r Plot option features over time}
sum_thet_dat = subset(theta_history, option %in% 0:5 & feature %in% 0:5)
gg_summary_theta = ggplot(sum_thet_dat, aes(trial, value, color = factor(action))) +
  geom_point() +
  labs(color="Action") +
  facet_grid(factor(option, levels=unique(sum_thet_dat$option), labels=paste("Option", unique(sum_thet_dat$option))) ~
             factor(feature, levels=unique(sum_thet_dat$feature), labels=paste("Feature", unique(sum_thet_dat$feature))))

gg_summary_theta2 = ggplot(sum_thet_dat, aes(trial, value, color = factor(feature))) +
  geom_point() +
  labs(color="Feature") +
  facet_grid(factor(option, levels=unique(sum_thet_dat$option), labels=paste("Option", unique(sum_thet_dat$option))) ~
             factor(action, levels=unique(sum_thet_dat$action), labels=paste("Action", unique(sum_thet_dat$action))))

if (gg_save) {
  ggsave(file.path(plot_dir, "gg_summary_theta.png"), gg_summary_theta, width = 10, height = 5)
  ggsave(file.path(plot_dir, "gg_summary_theta2.png"), gg_summary_theta2, width = 10, height = 5)
}
```

```{r Plot option values over time}
th0 = subset(theta_history, option == 0 & feature %in% 0:7 & action %in% 0:7)

tiles_opt = expand.grid(feature = 0:max(theta_history$feature), option = 0:max(theta_history$option), action = max(theta_history$action))
tiles = subset(theta_history, trial == max(th0$trial))  # & option %in% 0:2 & action %in% 0:9
gg_final_policies = ggplot(tiles, aes(feature, factor(action))) +
  geom_tile(aes(fill = value), colour = "white") +
  scale_fill_gradient(low = "white", high = "steelblue") +
  labs(x = "Feature", y = "ActionID") +
  facet_grid(~ factor(option, labels = paste("Option", unique(tiles$option))))

if (gg_save) {
  ggsave(file.path(plot_dir, "gg_features_over_time.png"), gg_features_over_time, width = 10, height = 5)
  ggsave(file.path(plot_dir, "gg_actions_over_time.png"), gg_actions_over_time, width = 10, height = 5)
  ggsave(file.path(plot_dir, "gg_final_policies.png"), gg_final_policies, width = 25, height = 3)
}
```
```{r}
```